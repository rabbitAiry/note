[TOC]

# 单片机的C语言

> 平时50% 期末50%



### 单片机基础知识 #1

##### 内部结构

- 中央处理器
  - 以ALU为中心的运算器
    - 算术逻辑单元ALU。能够进行算术、逻辑、位操作运算
    - 累加器ACC、暂存器TMP、8位寄存器PSW》寄存本次运的特征信息
    - 进位标志CY、半进位标志AC、用户可设定标志位F0、四个通用寄存器的选择位RS1-RS0、溢出标志OV、奇偶校验位P
  - 控制器、时钟电路和基本时序周期
    - 控制逻辑主要包括定时和控制逻辑、指令寄存器、译码器以及地址指针DPTR和程序计数器PC
    - 执行指令过程：从程序存贮器中取出指令送指令寄存器，然后指令译码器ID进行译码，译码产生一系列符合定时要求的微操作信号，用以控制单片机各部分动作
    - 控制器：在单片机内部协调各功能部件之间的数据传送、运算等操作
    - 8051的时钟：由一个反相放大器构成振荡器产生，可以是内部方式或外部方式
    - 8051的基本时序周期：振荡周期、时钟周期（=2\*振荡周期）、机器周期（=6*时钟周期）、指令周期
    - 指令部件：计数器PC、指令寄存器IR、指令译码器ID、数据指针DPTR（16位地址寄存器）
- 存贮器组织
  - 8051有（片内+片外）程序存贮器ROM和数据存贮器RAM（合4个），各自有各自的寻址机构和寻址方式
  - CPU提供控制信号EA用于选择内部和外部ROM
    - 4K字节地址区对于片内ROM和片外ROM是公用的，1000H+为外部ROM专用
    - EA接低电平时，CPU只从片外ROM读取指令
  - 8051通过不同的信号来选通ROM或RAM。从外部ROM读取指令时用选通信号'PSEN'，从外部RAM读写时用'RD'、'WR'
  - 片内RAM的低128个字节可以分为三个部分
    - 四组工作寄存器，每组占用8个RAM字节，记为R0-R7
    - 可位寻址区
    - 用户可用RAM
  - 堆栈指针SP
- 片内并行接口
  - 8051的4个8位并行接口：P0-3，共32根I/O线（双向通道、准）。每个口由4部分组成：端口锁存器、输入缓冲器、输出驱动器、端口引脚
    - 作输出时，内部带锁存器
    - 作输入时，两种工作方式：读端口（把锁存器中内容读入到内部总线）、读引脚（把外部数据读入到内部总线）
    - 作为外部输入线时，先通过代码把端口锁存器置1，然后再实行读引脚操作
- 8051的内部资源
  - 串行口：可编程的、全双工的串行接口
    - 串行收发存贮再SFR中的串行数据缓冲器SBUF中的数据
    - 机器内部有两个数据缓冲器：发送/接收，可以同时收发
  - 定时器/计数器
    - 两个定时器/计数器T0、T1
    - 控制功能由定时器方式控制寄存器TMOD来完成
    - 定时器计到规定数值时可以向CPU发出中断申请。由定时器控制寄存器TCON完成
    - 计时工作时，时钟由单片机内部提供，时钟脉冲由T0、T1输入
  - 中断系统
    - 8051的中断系统允许5个独立的中断源：2个外部、2个定时器计数器、1个串行
    - 外部中断申请通过’INT0和‘INT1输入
- 8051的芯片引脚
  - Vcc、Vss：接5v电源、接地
  - XTAL1、XTAL2：使用内部振荡电路时，用来接石英晶体和电容；使用外部振荡电路时，用来输入时钟脉冲
  - P0：双向IO口
  - P1-2：准双向口
  - P3：多用途端口
  - ALE/'PROG'：地址锁存信号输出端。在访问片外存贮器时，ALE为有效高电平时，P0口输出地址低8位，可以用ALE信号做外部地址锁存器的锁存信号。'PROG'是对8751的EPROM编程时的编程脉冲输入端
  - RST/V~PD~：复位信号输入端、备用电源输入端
  - 'EA'/V~PP~：内部和外部程序存贮器选择线。'EA'=0时选择在外部ROM的程序
  - 'PSEN'：片外程序存贮器选通信号
- 单片机工作方式
  - 复位方式
    - 复位信号是高电平有效，持续时间为24个振荡周期时时复位。P0-P3口置1（允许输入），计数器PC和SFR清0。8051的复位操作不影响内部RAM的内容
    - 自动复位、手工复位
  - 程序执行方式
  - 单步执行方式：使程序处于外加脉冲的情况下，一条指令一条指令地执行
  - 低功耗操作方式
    - 节电操作方式：CPU停止工作、其余继续
    - 掉电操作方式：仅给RAM供电
  - EPROM编程和校验方式
    - 内部EPROM编程
    - EPROM程序校验
    - 程序存贮器的保密位

##### 系统扩展

- 外部总线扩展
- 外部程序存贮器的扩展
- 外部数据存贮器的扩展

##### 指令系统

- 寻址方式：寄存器寻址、直接寻址、寄存器间接寻址、立即寻址、变址寻址、相对寻址、位寻址
- 指令
- 伪指令

##### 实用程序设计



[TOC]

### C51数据与运算 #3

##### 数据与数据类型

- 基本类型：bit, (unsigned/signed)(char, int, long), float, double
- 构造类型：array, struct, union, enum

##### 常量与变量

##### C51数据的存储类型与存储器结构

- 8051的4个存储空间：(片内/片外)(程序/数据)存储器

- 由于8051系列的程序计数器和DPTR都是16位字长的，最大可寻址空间为64K，地址范围0000H~0FFFFH

  <img src="C:\Users\Airy\AppData\Roaming\Typora\typora-user-images\image-20210407101505972.png" alt="image-20210407101505972" style="zoom:50%;" />

- ROM

  - $\overline{EA}$控制信号用于选择地址重叠去中的片内地址或片外地址

- RAM

  - 空间是数据存储空间，用于数据的暂存，缓冲，及运算结果的存放，也可用于设定标志位

  - 8051的数据存储器片内和片外的地址空间是独立的。片外地址空间用MOVX进行访问，片内则用MOV指令进行访问

  - SFR为特殊功能寄存器区，其余区域↓ 为片内128字节RAM区

    - 通用寄存器 00H~1FH，由四个寄存器构成，可用寄存器名/字节地址寻址
    - 可位寻址区20H~2FH，可按字节/按位地址寻址
    - 用户RAM区30H~7FH，只能用字节地址寻址

  - 编译器会将变量、常量定义成不同的存储类型并定位在不同的存储器中: data\bdata\idata\pdata\xdata\code

    ```c
    // 变量的存储类型定义例子
    
    char data var1;
    //定位在片内RAM中
    
    bit bdata flags;
    //定位在片内RAM中的位寻址区
    
    float idata x,y,z;
    //定位在片内RAM中，只能间接寻址的方法进行访问
    
    unsigned int pdata dimension;
    //定位在片外RAM中
    
    unsigned char xdata vector[10][4][4]
    //定义为xdata类型，定位在片外RAM中，占据10*4*4=160个字节存储空间
    ```

##### SFR及其CS1定义

- 8051有21个SFR，只能通过直接寻址方式访问。8051中，除了计数器PC和4组通用寄存器外，其他所有的寄存器均称为SFR

  - 仅适用于8051系列的直接访问方法

    `sfr sfr_name = int location`

    ```c
    sfr PSW = 0xD0;
    //定义PSW寄存器地址为0xD0
    
    sbit OV = PSW^2;
    //定义OV位为PSW.2地址为0xD2
    
    sbit CY = PSW^7;
    //定义CY位为PSW.7地址为0xD7
    
    sbit OV = 0xD0^2;
    sbit OV = 0xD2
    //OV地址为0xD2
    ```

  - 定义中的等号并非是赋值语句，而是SFR地址

  - 高字节必须位于低字节之后。这种定义适用于所有SFR，除定时/计数器

##### 8051并行接口及其C51定义

- 8051片内有4个8位的并行口，共32根I/O线。每个口主要由四部分组成：端口锁存器、输入缓冲器、输出缓冲器、端口引脚

  - 把这4个并行口统称P0~P3，其中P0为双向三态口，其余为准双向口

    ```c
    sfr P0 = 0x80
    //定义P0口，地址80H
      
    #include<absacc.h>
    #define PORTA XBYTE[0xffc0]
    //将PORTA定义为外部I/O口，地址为0xffc0
    ```

##### 位变量BIT及其C51定义

- 位变量的C51定义的语法及语义

  ```c
  bit direction_bit;
  // 将direction_bit定义为位变量
  ```

- 函数可包含类型为bit的参数，也可以作为返回值

- 对位变量定义的限制

  - 位变量不能定义为一个指针
  - 不存在位数组
  - 允许定义存储类型
  - 可位寻址对象

  ```c
  bdata int ibase, bdata char bary[4]
  // ibase定义为bdata整型变量，bary[4]定义为字符型数组
  sbit mybit = ibase^0;
  sbit Ary07 = bary[0]^7
  // mybit定义为ibase第0位，Ary07定义为bary[0]第7位
  Arr07 = 0
  bary[3] = 'a'
  // bary[0]第7位赋值为0，字节寻址：bary[3]赋值为'a'
  ```

##### C51运算符、表达式及其规则

- 运算符
  - 基本：加减乘除、求余
  - 算术表达式、优先级、结合性
  - 强制类型转换运算符()
    - 自动转换（往高）、强制转换（往低）
    - 低》高：char, int, unsigned, long, double。float, double
- 关系运算符
- 逻辑运算符
  - 自左向右
- C51位操作及其表达式
  - 位操作运算符
    - & 按位与：100B*110B=100B
    - |  按位或
    - ^  按位异或
    - ~  按位取反（唯一的单目运算符）：~100B=011B
    - << 位左移：100B<<2=10000B，溢出即舍弃
    - \>\> 位右移：越位即舍弃
      - 对二进制来说，移位相当于乘除2
  - 课本案例
- 自增减运算符、复合运算符
  - 自右向左





[TOC]

### 8051内部资源的C编程 #8

##### 中断

##### 定时器、计数器（T/C）

- 相关SFR
  - 计数寄存器TH、TL：用于设置T/C的初始值
  - T/C控制寄存器TCON：T/C需受到软件控制后才能启动计数，当计数寄存器计满时，产生向高位的进位TF，即溢出中断请求标志
  - T/C的方式控制寄存器TMOD：
    - 为计数器1和计数器0提供的控制位一样，各4位
    - M1、M0为工作选择位，共4种工作方式
    - C/$\overline{T}$：选择功能为计数器或定时器
    - GATE：门控信号
    - 程序中使用模式一可以直接设置`TMOD = 0x01;`
  - T/C2的控制寄存器
- T/C工作方式:star:
  - 方式0：TH提供8位，TL提供5位。T/C启动后加1计数，当13位计数满时TH向高位进位，此时产生中断请求
  - 方式1：TH、TL各提供8位。T/C启动后加1计数，当16位计数满时TH向高位进位，此时产生中断请求
  - 方式2：可自动重载的T/C，其中TH仅装载初值
  - 方式3：
- T/C的初始化
  - ①确定T/C的工作方式，②计算T/C的计数初值并装载到TH、TL，③T/C在中断方式工作时，须开CPU中断和源中断，④启动T/C
  - 定时器：若f~osc~=6MHz，则机器周期为12/f~osc~=2μs

##### 串行口1：原理

- 8051上有UART（Universal Asynchronous Receiver/Transmitter通用异步收发器）用于串行通信，发送时数据由TXD端送出，接收时由RXD端输入。有两个SBUF，一个作发送缓冲器，另一个作接收缓冲器。它是可编程的全双工的串行口
- 波特率（比特率）：发送一位二进制数据的速率，用baud表示。实验室使用了9600波特率
- 信号的接收：在UART通信过程中，是低位先发，高位后发的原则。没有数据时保持高电平，发送数据前先发一位0表示起始位，结束时发一位1表示结束位。
- 串行口的工作方式
- 串行口初始化
  1. 串行口波特率 的选用（串口助手中、程序中都要）
  2. 初始化步骤
     1. 确定定时器1的工作方式——编程TMOD寄存器
     
     2. 计算定时器1的初值——装载TH1、TL1
     
        ```c
        TH0 = 256 - (11059200/12) / baud;
        // 11.059200是书本的晶振
        ```
     
     3. 启动定时器1——编程TCON中的TR1位
     
     4. 确定串行口的控制——编程SCON
     
     5. 串行口在中断方式工作时，须开CPU和源中断——编程IE寄存器  *注：中断并未学习*



##### 串行口2：应用于通信

- 通信的三种方式：单工、半双工、全双工

- UART模块：不关心通信过程，只关心通信接过的模块

  - 串行口控制寄存器SCON

    - 由串行口工作方式控制位SM0、SM1决定模式。主要使用模式1

    ```c
    SCON = 0x50;   // 模式1
    ```

    - TI、RI发送中断标志、接收中断标志

  - 发送和接收电路
  - 电源控制寄存器PCON
    - SMOD是与串行口的波特率设置有关的选择位

[TOC]

## 实验：单片机编程

#### 亮灯#1

- 三极管截止

  - 三种状态：截止、放大、饱和。单片机中通常只用到截止和饱和两种状态
  - 口诀：箭头朝内 PNP，导通电压顺箭头过，电压导通，电流控制。箭头始端比末端高于0.7v以上

  <img src="C:\Users\Airy\AppData\Roaming\Typora\typora-user-images\image-20210426173633871.png" alt="image-20210426173633871" style="zoom:50%;" />c↓     e↑     b

  - 如果给LEDS6一个高电平1，b和e都是5v，不亮
  - 如果给LEDS6一个低电平0，产生压差，有(5-0.7)V 的电压会在电阻 R47 上，可以点亮LED2

- 三极管饱和

  - 要想处于饱和状态，b 极电 流就必须大于 e 和 c 之间电流值除以放大倍数β

- 三极管应用

  - 常用于控制、驱动

- 单片机的 IO 口数量是有限的，为了控制更多的器件，就要使用一些外围的数字芯片，如C51的74HC138 这个三八译码器
  - 三八译码器：把三种输入状态翻译成8种输出状态
  - ADDR0\~ADDR2对应着A0~A2，ENLED、ADDR3对应着使能端的三个脚，为了使译码器正常工作，ENLED=0，ADDR3=1
  - 代码中的组合使得只有Y6输出一个低电平，可以开通三极管Q16，5V电源加到了LED上
  - 让引脚P0.0=0，即DB_0 等于 0（74HC245），因此只有LED2和5v之间有压差，使得有电流通过，灯亮

#### 定时器 #2

- 定时器由特殊功能寄存器SFR控制
  - 计数寄存器TH、TL
  - 定时器/计数器控制寄存器TCON
  - T/C的方式控制寄存器TMOD

#### 中断 #3

- 设置中断，当单片机正在处理其他代码时遇到了中断，需要先处理中断的任务，然后继续回去处理原来的代码

- 使用中断

  - EA=1 中断总开关》开

  - ET0 = 1 计时器T0中断开关》开
  
  - ```
    void InterruptTimer0() interrupt 1
    ```

  - 常用：

    - interrupt 1 选择了定时器0的中断使能
    - interrupt 4 串口中断使能

#### 按键 #4

- 复位电路
- 按键消抖：当检测到按键状态变化时，不是立即去响应动作，而是先等待闭合或断开稳定后再 进行处理。按键消抖可分为硬件消抖和软件消抖。这里只介绍软件消抖
  - 延时10ms后再判断。但延时过程中就不能处理其他代码了
  - 每 2ms 进一次中断，扫描一次按 键状态并且存储起来，连续扫描 8 次后，看看这连续 8 次的按键状态是否是一致的

#### LCD显示（1602液晶） #5

- 1602：每行16个字符，共两行
  - 左上角的坐标是(0，0)
- 引脚
  - VSS、VDD 电源地、电源正极
  - VL 液晶显示偏压信号。用于调整显示的黑点和不显示的之间的对比度
  - RS 数据/命令选择端
  - R/W 读/写选择端
  - E 使能信号
  - D0-D7
- 1602读写时序
- 1602液晶的指令
  - 显示模式设置
  - 显示开关以及光标设置指令
  - 清屏指令
  - RAM地址设置指令

#### 综合编程 #6



















